import { SevadarCard } from "@/components/common/SevadarCard";
import { SevadarSearch } from "@/components/common/SevadarSearch";
import { Logo } from "@/components/illustration/Logo";
import { VideoViewer } from "@/components/scanner";
import { trpc } from "@/utils/trpc";
import { ScrollArea } from "@rssbskp/ui/scroll-area";
import { Tabs, TabsList, TabsTrigger } from "@rssbskp/ui/tabs";
import { signOut, useSession } from "next-auth/react";
import { forwardRef, useImperativeHandle, useRef, useState } from "react";
import { useForm } from "react-hook-form";
import toast, { Toaster } from "react-hot-toast";

export default function Scan() {
  const findSevadar = trpc.sevadar.find.useMutation();
  const attendance = trpc.attendance.create.useMutation();
  const { control, setValue, getValues, watch } = useForm({
    defaultValues: {
      isOut: false,
    },
  });
  const [scanMode, setScanMode] = useState<"qr" | "manual">("manual");
  const { data } = useSession();
  const bottomSheetRef = useRef(null);

  return (
    <main>
      <div className="h-14 fixed bg-white w-full flex gap-3 items-center font-semibold px-2 py-6 border-b border-b-muted">
        <Logo height={30} className="h-10 w-8" />
        RSSB
        <div className="ml-auto">
          <button onClick={() => signOut()} className="tag">
            Logout
            {/* {CENTER_MAP[data?.user.current_center! as 2026]} */}
          </button>
        </div>
      </div>
      <div className="flex flex-col gap-4 h-screen p-4 container max-w-lg">
        <div className="h-12 block">demo</div>
        <Tabs defaultValue="account" className="w-full">
          <TabsList className="w-full">
            <TabsTrigger
              className="grow"
              value="account"
              onClick={() => setValue("isOut", false)}
            >
              Punch In
            </TabsTrigger>
            <TabsTrigger
              className="grow"
              value="password"
              onClick={() => setValue("isOut", true)}
            >
              Punch out
            </TabsTrigger>
          </TabsList>
        </Tabs>

        {scanMode === "qr" && (
          <VideoViewer
            onDetected={(value) => {
              console.log(value);
              findSevadar.mutateAsync({
                zims_id: value,
                page: {
                  limit: 40,
                  offset: 0,
                },
              });
            }}
          />
        )}
        <SevadarSearch
          onQRClick={() =>
            setScanMode((mode) => (mode === "qr" ? "manual" : "qr"))
          }
          onSearch={async (data) => {
            if (!data.zims_id && !data.name && !data.father_name)
              return toast.error("Please enter atleast one field");
            await findSevadar.mutateAsync({
              ...data,
              page: {
                limit: 40,
                offset: 0,
              },
            });
          }}
        />
        <ScrollArea className=" mt-2 ">
          {/* <div className="flex w-max space-x-4 p-4"> */}
          {findSevadar.isLoading && <div>Loading...</div>}
          {findSevadar.isSuccess &&
            findSevadar.data.map((sevadar, index) => (
              <SevadarCard
                key={index}
                action={"Mark " + (watch("isOut") ? "out" : "in")}
                {...sevadar}
                onAction={async (s) => {
                  return bottomSheetRef.current.open(sevadar);
                  const { isOut } = getValues();
                  await attendance
                    .mutateAsync({
                      sevadar_id: s.id,
                      isOut,
                    })
                    .then(() => {
                      toast.success(
                        sevadar.name + " marked " + (isOut ? "out" : "in")
                      );
                    })
                    .catch((e) => {
                      toast.error(e.message);
                    });
                }}
              />
            ))}
          {findSevadar.error && <div>{findSevadar.error.message}</div>}
          {findSevadar.data?.length === 0 && <div>No sevadars found</div>}
          {/* </div> */}
          {/* <ScrollBar orientation="horizontal" /> */}
        </ScrollArea>
        <Toaster />
        <SheetDemo ref={bottomSheetRef} isOut={watch("isOut")} />
      </div>
    </main>
  );
}

Scan.onlyAuth = true;

import { sevadar } from "@prisma/client";
import { Avatar, AvatarFallback, AvatarImage } from "@rssbskp/ui/avatar";
import { Button } from "@rssbskp/ui/button";
import { Input } from "@rssbskp/ui/input";
import { Label } from "@rssbskp/ui/label";
import {
  Sheet,
  SheetClose,
  SheetContent,
  SheetDescription,
  SheetFooter,
  SheetHeader,
} from "@rssbskp/ui/sheet";

const SheetDemo = forwardRef(function SheetDemo(props, ref) {
  const [sevadar, setOpen] = useState<sevadar | null>(null);

  useImperativeHandle(ref, () => ({
    open: setOpen,
  }));

  // const attendance = trpc.attendance.create.useMutation();

  return (
    <Sheet open={!!sevadar} onOpenChange={() => setOpen(null)}>
      <SheetContent side={"bottom"} className="shadow-2xl">
        <form className="max-w-lg mx-auto space-y-2">
          <SheetHeader>
            {/* <SheetTitle>Mark {props.isOut ? "Out" : "In"}</SheetTitle> */}
            <SheetDescription>
              {/* Make changes to your profile here. Click save when you're done. */}
            </SheetDescription>
          </SheetHeader>
          <div className="flex flex-col gap-4 p-4 font-bold items-center">
            <Avatar className="h-60 w-60 rounded-none self-center ">
              <AvatarImage
                // src={b(sevadar.sevadar_image[0]?.image)}
                className="aspect-square h-full w-full"
                alt=""
              />
              <AvatarFallback className="rounded-none">
                {sevadar?.name}
              </AvatarFallback>
            </Avatar>

            <div className="font-semibold text-xl opacity-60">
              {sevadar?.zims_id}
            </div>
            <div className="font-semibold text-2xl">
              {sevadar?.name} ({sevadar?.gender?.[0]})
            </div>
            <table className="w-60">
              <tr>
                <td className=" opacity-50">F/H Name:</td>
                <td>{sevadar?.father_name}</td>
              </tr>
              <tr>
                <td className=" opacity-50">Department:</td>
                <td>{sevadar?.department}</td>
              </tr>
              <tr>
                <td className=" opacity-50">Center:</td>
                <td>{sevadar?.center_name}</td>
              </tr>
              <tr>
                <td className=" opacity-50">Badge type:</td>
                <td>{sevadar?.badge_type}</td>
              </tr>
            </table>
          </div>
          <div className="">
            <Label htmlFor="name" className="text-right">
              Sevadar Name
            </Label>
            <Input value={sevadar?.name} readOnly className="col-span-3" />
          </div>
          <div className="">
            <Label htmlFor="name" className="text-right">
              Father/Husband Name
            </Label>
            <Input value={sevadar?.name} readOnly className="col-span-3" />
          </div>
          <div className="">
            <Label htmlFor="name" className="text-right">
              Seva place
            </Label>
            <Input id="name" value="Pedro Duarte" className="col-span-3" />
          </div>
          <div className="">
            <Label htmlFor="name" className="text-right">
              Seva place
            </Label>
            <Input id="name" value="Pedro Duarte" className="col-span-3" />
          </div>
          <SheetFooter>
            <SheetClose asChild>
              <Button type="submit">Save changes</Button>
            </SheetClose>
          </SheetFooter>
        </form>
      </SheetContent>
    </Sheet>
  );
});
